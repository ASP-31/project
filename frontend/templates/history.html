<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Incident History | Air Quality System</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex flex-col">

<!-- HEADER -->
<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3 font-bold text-xl">
        <div
          id="logo"
          class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center text-white hover:cursor-pointer">
          <svg viewBox="0 0 24 24" class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M2 12h10" />
            <path d="M9 18h3a3 3 0 0 0 3-3V9a3 3 0 0 1 3-3h3" />
            <path d="M12 12a3 3 0 0 1 3 3v3" />
          </svg>
        </div>
        <span id="heading" class="bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-700 hover:cursor-pointer">
          Air Quality <span class="text-blue-600">System</span>
        </span>
      </div>

    <nav class="flex gap-8 text-slate-600 font-medium">
      <a href="dashboard.html">Dashboard</a>
      <a href="history.html" class="text-blue-600 font-semibold">History</a>
      <a href="incident.html">Incident</a>
      <a href="map.html">Map</a>
      
    </nav>
  </div>
</header>

<!-- CONTENT -->
<main class="max-w-6xl mx-auto px-6 py-10 space-y-8 flex-grow">

  <!-- HEADER -->
  <section class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-extrabold">Incident History</h1>
      <p class="text-slate-600 text-sm">
        Pollution incidents investigated by the user
      </p>
    </div>

    <button
      onclick="clearHistory()"
      class="px-5 py-2 rounded-xl bg-red-600 text-white font-semibold shadow hover:bg-red-700 transition">
      Clear History
    </button>
  </section>

  <!-- TABLE -->
  <section class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-4 text-left">Station</th>
          <th class="p-4 text-left">PM2.5</th>
          <th class="p-4 text-left">AQI</th>
          <th class="p-4 text-left">Severity</th>
          <th class="p-4 text-left">Timestamp</th>
          <th class="p-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="historyTable" class="divide-y"></tbody>
    </table>
  </section>

  <!-- EMPTY STATE -->
  <p id="emptyState" class="text-center text-slate-500 hidden">
    No incident history available
  </p>

</main>

<!-- FOOTER -->
<footer class="bg-slate-900 text-slate-300 mt-20">
  <div class="text-center py-6 text-sm border-t border-slate-700">
    © 2026 Ernakulam Air Quality Project
  </div>
</footer>

<!-- STORAGE SERVICE -->
<script src="services/storage.js"></script>

<script>
  const table = document.getElementById('historyTable');
  const emptyState = document.getElementById('emptyState');

  // Helper to get history directly from localStorage
  function getHistory() {
    return JSON.parse(localStorage.getItem('incidentLog')) || [];
  }

  function severityFromAQI(aqi) {
    if (aqi > 200) return '<span class="text-red-600 font-bold">Severe</span>';
    if (aqi > 100) return '<span class="text-orange-500 font-bold">Moderate</span>';
    return '<span class="text-emerald-600 font-bold">Low</span>';
  }

  function renderHistory() {
    const history = getHistory();
    table.innerHTML = '';

    if (history.length === 0) {
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');

    // We reverse to show the latest incidents at the top
    [...history].reverse().forEach((item) => {
      // Use the station name as a unique identifier for actions
      const stationId = encodeURIComponent(item.station);
      
      table.innerHTML += `
        <tr class="hover:bg-slate-50 transition">
          <td class="p-4 font-bold text-slate-800">${item.station}</td>
          <td class="p-4 text-slate-600">${item.pm25} µg/m³</td>
          <td class="p-4 font-mono font-bold">${item.aqi}</td>
          <td class="p-4">${severityFromAQI(item.aqi)}</td>
          <td class="p-4 text-slate-500 text-xs">${new Date(item.timestamp || Date.now()).toLocaleString()}</td>
          <td class="p-4 text-right space-x-2">
            <button
              onclick="viewIncident('${stationId}')"
              class="px-4 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold transition shadow-sm">
              View Map
            </button>
            <button
              onclick="deleteIncident('${stationId}')"
              class="px-4 py-1.5 rounded-lg bg-slate-200 hover:bg-red-50 hover:text-red-600 text-slate-700 text-xs font-bold transition">
              Delete
            </button>
          </td>
        </tr>
      `;
    });
  }

  // View logic: Syncs with Map.html
  function viewIncident(stationId) {
    const history = getHistory();
    const incident = history.find(i => encodeURIComponent(i.station) === stationId);
    
    if (incident) {
      // Set the active incident so Map.html knows where to go
      localStorage.setItem('activeIncident', JSON.stringify(incident));
      window.location.href = 'map.html';
    }
  }

  function deleteIncident(stationId) {
    let history = getHistory();
    history = history.filter(i => encodeURIComponent(i.station) !== stationId);
    localStorage.setItem('incidentLog', JSON.stringify(history));
    renderHistory();
  }

  function clearHistory() {
    if (!confirm('This will permanently delete all saved incident records. Continue?')) return;
    localStorage.removeItem('incidentLog');
    renderHistory();
  }

  // Initial Render
  renderHistory();
</script>
</body>
</html>


