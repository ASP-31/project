<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Incident Map | Air Quality System</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    #map {
      height: 520px;
    }
  </style>
</head>

<body class="bg-slate-100">

  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3 font-bold text-xl">
        <div
          id="logo"
          class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center text-white hover:cursor-pointer">
          <svg viewBox="0 0 24 24" class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M2 12h10" />
            <path d="M9 18h3a3 3 0 0 0 3-3V9a3 3 0 0 1 3-3h3" />
            <path d="M12 12a3 3 0 0 1 3 3v3" />
          </svg>
        </div>
        <span id="heading" class="bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-700 hover:cursor-pointer">
          Air Quality <span class="text-blue-600">System</span>
        </span>
      </div>

      <nav class="flex gap-8 text-slate-600 font-medium">
        <a href="dashboard.html">Dashboard</a>
        <a href="history.html" >History</a>
        <a href="incident.html">Incident</a>
        <a href="map.html" class="text-blue-600 font-semibold">Map</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-10 grid lg:grid-cols-3 gap-8">

    <aside class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-6">
      <h2 class="text-xl font-bold">Incident Explorer</h2>

      <div>
        <label class="block text-sm font-medium text-slate-600 mb-2">City</label>
        <select id="citySelect"
          class="w-full rounded-xl border border-slate-300 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500">
          <option value="Ernakulam">Ernakulam</option>
          <option value="Delhi">Delhi</option>
          <option value="Mumbai">Mumbai</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-600 mb-2">Monitoring Station</label>
        <select id="stationSelect"
          class="w-full rounded-xl border border-slate-300 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500">
        </select>
      </div>

      <div class="rounded-2xl bg-gradient-to-br from-emerald-50 to-white border border-emerald-200 p-5">
        <h3 class="font-semibold text-emerald-700 mb-2">Station Overview</h3>
        <div id="sidebarContent">
          <p class="text-sm text-slate-500 italic">Select a station to view details...</p>
        </div>
      </div>

      <button onclick="location.href='suspected.html'"
        class="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold shadow-md hover:shadow-lg transition">
        View AI Analysis
      </button>
    </aside>

    <section class="lg:col-span-2 bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
      <h2 class="text-xl font-bold mb-4">Live Incident Map</h2>
      <div id="map" class="rounded-xl"></div>
      <p class="text-sm text-slate-500 mt-4">Red markers indicate AI-identified suspect sources within the influence
        zone.</p>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1. DATA MAPPING
    const cityStations = {
      "Ernakulam": ["Vyttila Mobility Hub", "Kaloor Junction", "Kakkanad SmartCity", "Edappally Toll", "MG Road (Maharajas)", "Eloor Industrial Area", "Aluva Manappuram", "Kalamassery Startup Village", "Fort Kochi Pier", "Tripunithura Statue"],
      "Delhi": ["Anand Vihar ISBT", "R.K. Puram", "Punjabi Bagh", "ITO Junction"],
      "Mumbai": ["Bandra Kurla Complex", "Colaba", "Worli", "Borivali"]
    };

    const coordsMap = {
      "Vyttila Mobility Hub": [9.9670, 76.3200], "Kaloor Junction": [9.9920, 76.2910], "Kakkanad SmartCity": [10.0085, 76.3620],
      "Edappally Toll": [10.0250, 76.3120], "MG Road (Maharajas)": [9.9750, 76.2850], "Eloor Industrial Area": [10.0450, 76.2950],
      "Aluva Manappuram": [10.1080, 76.3550], "Kalamassery Startup Village": [10.0520, 76.3250], "Fort Kochi Pier": [9.9680, 76.2420],
      "Tripunithura Statue": [9.9510, 76.3480], "Anand Vihar ISBT": [28.6476, 77.3158], "R.K. Puram": [28.5653, 77.1747],
      "Punjabi Bagh": [28.6671, 77.1259], "ITO Junction": [28.6300, 77.2400], "Bandra Kurla Complex": [19.0675, 72.8684],
      "Colaba": [18.9067, 72.8147], "Worli": [19.0178, 72.8173], "Borivali": [19.2307, 72.8567]
    };

    // 2. INITIALIZE MAP (Defaults to Ernakulam center)
    const map = L.map("map").setView([9.9670, 76.3200], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    // 3. CORE FUNCTIONS
    function populateStations(targetStation = null) {
      const city = document.getElementById("citySelect").value;
      const stationSelect = document.getElementById("stationSelect");
      stationSelect.innerHTML = "";

      cityStations[city].forEach(s => {
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = s;
        stationSelect.appendChild(opt);
      });

      // If we came from Dashboard, select that specific station
      if (targetStation) {
        stationSelect.value = targetStation;
      }

      updateMap(stationSelect.value);
    }

    async function updateMap(stationName) {
      if (!stationName) return;
      try {
        const response = await fetch(`http://localhost:3000/api/report?zone=${encodeURIComponent(stationName)}`);
        const data = await response.json();

        markersLayer.clearLayers();
        const currentCoords = coordsMap[stationName];

        // Pan and Zoom smoothly to the station
        map.flyTo(currentCoords, 14, { duration: 1.5 });

        // Main Station Marker
        L.marker(currentCoords).addTo(markersLayer)
          .bindPopup(`<b>Station: ${data.station}</b><br>AQI: ${data.aqi}`)
          .openPopup();

        // Suspect Markers (AI and Approved)
        if (data.suspects) {
          data.suspects.forEach(site => {
            L.circleMarker([site.lat, site.lng], {
              radius: 10, color: '#ef4444', fillOpacity: 0.6
            }).addTo(markersLayer)
              .bindPopup(`<b>Suspect: ${site.name}</b><br>${site.distance} km away`);
          });
        }

        // Update UI Sidebar
        document.getElementById("sidebarContent").innerHTML = `
                <p class="text-sm text-slate-700"><strong>Station:</strong> ${data.station}</p>
                <p class="text-sm text-slate-700"><strong>Status:</strong> ${data.isSpike ? '<span class="text-red-600 font-bold">Spike</span>' : 'Normal'}</p>
                <p class="text-sm text-slate-700"><strong>PM2.5:</strong> ${data.pm25} µg/m³</p>
            `;

        // Ensure this station remains active for the Suspected page
        localStorage.setItem('activeIncident', JSON.stringify(data));
      } catch (error) {
        console.error("Map Update Error:", error);
      }
    }

    // 4. LISTENERS
    document.getElementById("citySelect").addEventListener("change", () => populateStations());
    document.getElementById("stationSelect").addEventListener("change", (e) => updateMap(e.target.value));

    // 5. THE CRITICAL REDIRECT LOGIC
    window.onload = () => {
      const incidentData = JSON.parse(localStorage.getItem('activeIncident'));

      if (incidentData && incidentData.station) {
        let foundCity = null;

        // Search through our mapping to find the city for this station
        for (const [city, stations] of Object.entries(cityStations)) {
          if (stations.includes(incidentData.station)) {
            foundCity = city;
            break;
          }
        }

        if (foundCity) {
          // Set the City dropdown
          document.getElementById("citySelect").value = foundCity;
          // Populate stations and specifically select the target station
          populateStations(incidentData.station);
        } else {
          populateStations();
        }
      } else {
        populateStations();
      }
    };
    heading.addEventListener("click",()=>{
    window.location.href='index.html'
  })
    logo.addEventListener("click",()=>{
    window.location.href='index.html'
  })
  </script>
</body>

</html>